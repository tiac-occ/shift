<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <link rel="manifest" href="manifest.json">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OCC Duty Management Platform</title>
  
<style>
/* --- 【新增】標示今天日期的圈圈樣式 (個人月曆用) --- */
.calendar-day.today {
  position: relative;
}

.calendar-day.today::after {
  content: '';
  position: absolute;
  top: -3px; left: -3px; right: -3px; bottom: -3px;
  border: 4px outset #CC9B86;
  border-radius: 8px;
  box-sizing: border-box;
  animation: draw-circle 0.5s ease-in-out forwards;
}

@keyframes draw-circle {
  from { transform: scale(1.5); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

/* --- Header 頂部佈局 --- */
.header-top-row {
  position: relative;
  width: 100%;
  min-height: 45px;
}

/* --- 啟動畫面樣式 --- */
#splash-screen {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background-color: #4A5052; 
  z-index: 9999;
  display: flex; justify-content: center; align-items: center;
  transition: opacity 0.5s ease-out;
}
#splash-screen img { width: 300px; height: 300px; }
#splash-screen.hidden { opacity: 0; pointer-events: none; }

/* --- 全局與顏色設定 --- */
:root {
  --starlux-header: #3E4B5C; --starlux-teal-light: #e6f0f3; --starlux-gold-light: #f5eeda;
  --starlux-rose-gold: #f5eeda; --starlux-gray: #f0f2f5; --starlux-highlight-a: #7D8C91;
  --starlux-highlight-b: #AD9F74; --text-color: #333; --border-color: #d8dde0;
  --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background-color: var(--starlux-gray); color: var(--text-color); }

/* --- 登入畫面樣式 --- */
#login-container { display: none; justify-content: center; align-items: center; width: 100%; height: 100vh; }
.login-box { max-width: 400px; width: 90%; padding: 30px; background: #fff; border-radius: 12px; box-shadow: var(--shadow); text-align: center; }
.login-box h1 { color: var(--starlux-header); }
#login-form { display: flex; flex-direction: column; gap: 15px; }
.form-field { display: flex; flex-direction: column; text-align: left; }
.form-field label { font-weight: bold; margin-bottom: 5px; color: var(--starlux-header); }
.form-field input { font-size: 1em; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); }
#login-btn { padding: 12px; font-size: 1.2em; background-color: var(--starlux-header); color: white; border: none; border-radius: 8px; cursor: pointer; }
#login-error { color: #dc3545; margin-top: 15px; min-height: 1.2em; font-size: 0.9em; }

/* --- 主應用程式樣式 --- */
#app-wrapper { display: none; height: 100vh; }
#sidebar { width: 220px; background-color: var(--starlux-header); color: white; padding-top: 20px; display: flex; flex-direction: column; transition: transform 0.3s ease; transform: translateX(-100%); position: fixed; height: 100%; z-index: 2000; }
#sidebar.open { transform: translateX(0); }
#sidebar-header { text-align: center; padding: 0 20px 20px; border-bottom: 1px solid rgba(255,255,255,0.2); }
#sidebar-header #user-info { font-weight: bold; word-break: break-all; }

/* --- 側邊欄主選單 --- */
#sidebar-nav { display: flex; flex-direction: column; flex-grow: 1; margin-top: 20px; padding: 0 5px; gap: 10px; }
#sidebar-nav a { color: white; text-decoration: none; padding: 15px 20px; font-size: 1.1em; font-weight: bold; text-align: center; border-radius: 6px; border-left: 3px solid transparent; }
#sidebar-nav a:hover { background-color: rgba(255, 255, 255, 0.1); }
#sidebar-nav a.active { background-color: rgba(0, 0, 0, 0.2); border-left-color: var(--starlux-gold-light); }
#logout-btn { background: none; color: white; text-align: center; border: none; padding: 15px 20px; font-size: 1.1em; cursor: pointer; width: 100%; border-top: 1px solid rgba(255,255,255,0.2); margin-bottom: 20px; }
#logout-btn:hover { background-color: rgba(255,255,255,0.1); }
#content-wrapper { width: 100%; height: 100vh; display: flex; flex-direction: column; }
#sidebar-toggle { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; color: white; font-size: 2em; cursor: pointer; width: 45px; padding: 0; z-index: 10; }
#overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999; }
#sidebar.open ~ #overlay { display: block; }

/* --- Header --- */
.header { background-color: var(--starlux-header); color: white; padding: 10px 0px 15px; text-align: center; position: sticky; top: 0; z-index: 1000; box-shadow: var(--shadow); }
.month-selector { display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 0; }
.month-selector button { background: none; border: 1px solid rgba(255, 255, 255, 0.5); color: white; font-size: 1.5em; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; flex-shrink: 0; display: flex; justify-content: center; align-items: center; padding: 0; padding-bottom: 3px; }
.month-selector h1 { margin: 0 10px; font-size: 1.5em; white-space: nowrap; }

nav { display: flex; background-color: rgba(255, 255, 255, 0.8); padding: 5px; border-radius: 8px; margin: 10px auto 0; max-width: 500px; width: 90%; backdrop-filter: blur(5px); }
.view-selector { display: none; }
nav button { flex: 1; padding: 10px; font-size: 1em; background: none; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: var(--starlux-header); }
nav button.active { background-color: var(--starlux-header); color: white; }
main { padding: 10px; max-width: 1400px; margin: 0 auto; width: 100%; box-sizing: border-box; overflow-y: auto; flex-grow: 1; }
.page { display: none; }
.page.active { display: block; }
.view { display: none; }
.view.active { display: block; }

/* --- Logout Confirm --- */
#logout-confirm { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 3000; text-align: center; }
#logout-confirm p { margin: 0 0 20px; font-size: 1.2em; }
#logout-confirm button { padding: 10px 20px; font-size: 1em; border: none; border-radius: 8px; cursor: pointer; margin: 0 10px; }
#confirm-logout-yes { background-color: #dc3545; color: white; }
#confirm-logout-no { background-color: #6c757d; color: white; }

/* --- 其他元件 --- */
.controls { margin-bottom: 15px; text-align: center; display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; }
.controls label { font-weight: bold; color: var(--starlux-header); }
.controls select { font-size: 1.1em; padding: 8px; border-radius: 8px; border: 1px solid var(--border-color); }
.message-box { text-align: center; padding: 20px; margin-top: 15px; margin-bottom: 15px; border-radius: 8px; font-weight: bold; background-color: #e9ecef; max-width: 90%; margin-left: auto; margin-right: auto; }
.message-box.error { background-color: #f8d7da; color: #dc3545; }
.message-box.success { background-color: #d4edda; color: #155724; }

/* --- 每日卡片樣式 (維持上一版正確的 CSS) --- */
.day-card { background-color: #fff; border-radius: 12px; margin-bottom: 12px; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
.day-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; cursor: pointer; }
.day-header h2 { margin: 0; font-size: 1.2em; color: var(--starlux-header); }
.day-details { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
.day-card.open .day-details { max-height: 1500px; }
.assignment-row { padding: 10px 20px; border-top: 1px solid var(--starlux-gray); }
.assignment-row-title { font-weight: bold; color: #795548; margin-bottom: 8px; font-size: 0.9em; }

.assignment-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }

/* 卡片容器：Flexbox 直向排列 */
.assignment { 
  padding: 8px 10px; 
  border-radius: 6px;
  display: flex;
  flex-direction: column;
  height: 100%;
  box-sizing: border-box;
}

.assignment.day-shift { background-color: var(--starlux-gold-light); }
.assignment.night-shift { background-color: var(--starlux-teal-light); }

/* 職稱區塊：靠左、垂直置中、佔滿上方 */
.assignment .position { 
  font-size: 0.85em; 
  color: #555; 
  white-space: pre-line; 
  line-height: 1.2; 
  margin-bottom: 4px;
  flex-grow: 1;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  text-align: left;
}

/* 姓名區塊：推到底部 */
.assignment .name { 
  font-weight: bold; 
  font-size: 0.95em; 
  color: #000; 
  margin-top: auto;
}

/* --- 全員表格 --- */
.table-container { overflow: auto; max-height: 70vh; border-radius: 8px; box-shadow: var(--shadow); }
.full-roster-table { border-collapse: collapse; width: 100%; text-align: center; table-layout: fixed; }
.full-roster-table th, .full-roster-table td { border: 1px solid var(--border-color); padding: 8px; font-size: 0.9em; white-space: pre-line; width: 45px; }
.full-roster-table th:first-child, .full-roster-table td:first-child { width: 56px; font-size: 0.85em; }
.full-roster-table thead th { position: sticky; top: 0; z-index: 2; }
.full-roster-table tbody td:first-child { position: sticky; left: 0; font-weight: bold; z-index: 1; }
.full-roster-table thead th:first-child { z-index: 3; }
.full-roster-table th.day-shift { background-color: var(--starlux-gold-light); }
.full-roster-table th.night-shift { background-color: var(--starlux-teal-light); }
.full-roster-table thead th:first-child, .full-roster-table tbody td:first-child { background-color: var(--starlux-rose-gold); }
.full-roster-table .highlight-a { background-color: var(--starlux-highlight-a) !important; color: white; font-weight: bold; }
.full-roster-table .highlight-b { background-color: var(--starlux-highlight-b) !important; color: white; font-weight: bold; }
.full-roster-table th:nth-child(3), .full-roster-table td:nth-child(3) { border-right: 2px solid var(--starlux-header); }
.full-roster-table th:nth-child(12), .full-roster-table td:nth-child(12) { border-right: 2px solid var(--starlux-header); }

/* --- 月曆共用 --- */
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
.calendar-weekday { font-weight: bold; text-align: center; padding: 8px; color: var(--starlux-header); }
.calendar-day { border: 1px solid var(--border-color); border-radius: 8px; min-height: 100px; padding: 5px; background-color: #fff; box-shadow: var(--shadow); }
.calendar-day.empty { background-color: transparent; border: none; box-shadow: none; }
.calendar-day .day-number { font-weight: bold; font-size: 0.9em; color: #888; }
.calendar-day .shift-info { font-size: 0.8em; margin-top: 5px; white-space: pre-line; line-height: 1.3; font-weight: bold; }
.calendar-day.day-shift { background-color: var(--starlux-gold-light); }
.calendar-day.night-shift { background-color: var(--starlux-teal-light); }
.calendar-day.day-off { background-color: #fff; }

/* --- 表單 --- */
.form-container { max-width: 600px; margin: 20px auto; padding: 20px; background: #fff; border-radius: 12px; box-shadow: var(--shadow); }
.form-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
.form-field label { font-weight: bold; margin-bottom: 5px; color: var(--starlux-header); }
.form-field input, .form-field select { font-size: 1em; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); width: 100%; box-sizing: border-box; }
.submit-btn { padding: 12px; font-size: 1.2em; background-color: var(--starlux-header); color: white; border: none; border-radius: 8px; cursor: pointer; transition: opacity 0.2s; }
.submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

/* --- 誰來接班 --- */
#successorView .controls { margin-top: 20px; }
#successor-results { margin-top: 20px; padding: 20px; background: #fff; border-radius: 8px; box-shadow: var(--shadow); }
#successor-list { font-size: 1.1em; line-height: 1.8; }

/* --- 雙月曆比對 --- */
.comparison-calendar-container { display: grid; grid-template-columns: 1fr; gap: 30px; }
.calendar-section h3 { color: var(--starlux-header); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); text-align: center; }

/* --- 表單用互動式月曆 --- */
.interactive-calendar .calendar-day { cursor: pointer; transition: transform 0.1s ease, border-color 0.2s; }
.interactive-calendar .calendar-day:hover { transform: scale(1.02); background-color: rgba(0, 0, 0, 0.02); }
.interactive-calendar .calendar-day[data-has-shift="false"] { cursor: not-allowed; opacity: 0.6; }
.calendar-day.selected-shift { border: 3px solid var(--starlux-header) !important; background-color: rgba(173, 159, 116, 0.15) !important; position: relative; box-shadow: 0 0 10px rgba(62, 75, 92, 0.3); transform: scale(1.05); z-index: 10; }

/* --- 確認彈出視窗 (Modal) --- */
.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 5000; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
.modal-box { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); text-align: center; border: 1px solid var(--starlux-gold-light); animation: popIn 0.3s ease-out; }
@keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.modal-content { font-size: 1.2em; margin-bottom: 25px; line-height: 1.6; color: var(--starlux-header); font-weight: bold; }
.modal-actions { display: flex; gap: 15px; justify-content: center; }
.modal-btn { flex: 1; padding: 12px; border: none; border-radius: 6px; font-size: 1.1em; cursor: pointer; font-weight: bold; }
.btn-cancel { background-color: #d8dde0; color: #555; }
.btn-confirm { background-color: var(--starlux-header); color: white; }

/* --- 每日值班：當天日期的高亮與自動展開樣式 --- */
.day-card.today-highlight {
  border: 3px solid #CC9B86 !important; /* 強制使用金色邊框 */
  box-shadow: 0 0 15px rgba(204, 155, 134, 0.5); /* 加一點金色光暈 */
  animation: pulse-border 2s infinite; /* 呼吸燈效果 */
}

@keyframes pulse-border {
  0% { box-shadow: 0 0 10px rgba(204, 155, 134, 0.3); }
  50% { box-shadow: 0 0 20px rgba(204, 155, 134, 0.6); }
  100% { box-shadow: 0 0 10px rgba(204, 155, 134, 0.3); }
}


</style>
</head>
<body>
<div id="splash-screen">
    <img src="icon-512.png" alt="應用程式 Logo">
  </div>
  <div id="login-container">
    <div class="login-box">
      <h1>OCC 班表管理平台</h1>
      <form id="login-form">
        <div class="form-field">
          <label for="email">電子郵件</label>
          <input type="email" id="email" required>
        </div>
        <div class="form-field">
          <label for="password">密碼</label>
          <input type="password" id="password" required>
        </div>
        <button type="submit" id="login-btn">登入</button>
        <p id="login-error"></p>
      </form>
    </div>
  </div>

  <div id="app-wrapper">
    <div id="sidebar">
      <div id="sidebar-header">
        <span id="user-info"></span>
      </div>
      <nav id="sidebar-nav">
        <a href="#" data-page="home" class="active">首頁</a>
        <a href="#" data-page="shiftZone">調代專區</a>
        <a href="#" data-page="account">帳號管理</a>
      </nav>
      <button id="logout-btn">登出</button>
    </div>
    <div id="overlay"></div>

    <div id="content-wrapper">
       
<header class="header">
  <div class="header-top-row">
    <button id="sidebar-toggle">☰</button>
    <div class="month-selector">
      <button id="prevMonthBtn">&lt;</button>
      <h1 id="monthTitle"></h1>
      <button id="nextMonthBtn">&gt;</button>
    </div>
      </div>

  <nav id="homeViewSelector" class="view-selector" style="display: flex;">
    <button data-view="personalCalendarView" class="active">個人班表</button>
    <button data-view="dailyCardView">每日值班</button>
    <button data-view="fullTableView">全員班表</button>
  </nav>
  
  <nav id="shiftZoneViewSelector" class="view-selector" style="display: none;">
    <button data-view="shiftChangeView" class="active">調代申請</button>
    <button data-view="successorView">誰來接班</button>
  </nav>
</header>

      <main>
        <div id="messageContainer"></div>

        <div id="home" class="page active">
          <div id="dailyCardView" class="view"></div>
          <div id="fullTableView" class="view">
            <div class="controls">
              <label for="highlighter1">搜尋1:</label>
              <select id="highlighter1"><option value="">無</option></select>
              <label for="highlighter2">搜尋2:</label>
              <select id="highlighter2"><option value="">無</option></select>
            </div>
            <div id="tableContainer"></div>
          </div>
          <div id="personalCalendarView" class="view active">
            <div class="comparison-calendar-container">
              <div class="calendar-section">
                <h3 id="myScheduleTitle">我的班表</h3>
                <div id="myPersonalCalendarContainer"></div>
              </div>
              <div class="calendar-section">
                <div class="controls">
                  <label for="personSelector">對照同仁:</label>
                  <select id="personSelector"><option value="">請選擇人員...</option></select>
                </div>
                <div id="colleagueCalendarContainer"></div>
              </div>
            </div>
          </div>
        </div>

        <div id="shiftZone" class="page">
            <div id="shiftChangeView" class="view active">
              <div class="form-container">
                <div id="formMessageContainer"></div>
                
                <form id="shiftChangeForm" class="form-grid">
                  <input type="hidden" id="originalDate" name="originalDate">
                  <input type="hidden" id="originalShift" name="originalShift">
                  <input type="hidden" id="swappedDate" name="swappedDate">
                  <input type="hidden" id="swappedShift" name="swappedShift">
                
                  <div class="form-field">
                    <label for="originalPerson">選擇申請人員 (1)</label>
                    <select id="originalPerson" name="originalPerson" required></select>
                  </div>
                  
                  <div class="form-field">
                    <label>請點選欲調整的班別：</label>
                    <div id="sourceCalendarContainer" class="interactive-calendar" style="min-height:200px;">
                      (請先選擇人員)
                    </div>
                  </div>
                
                  <hr style="border:0; border-top:1px dashed #ccc; margin:10px 0;">
                
                  <div class="form-row">
                    <div class="form-field">
                      <label for="changeType">申請類型</label>
                      <select id="changeType" name="changeType" required>
                        <option value="給">給班</option>
                        <option value="調">調班</option>
                      </select>
                    </div>
                    <div class="form-field">
                      <label for="newPerson">選擇對象人員 (2)</label>
                      <select id="newPerson" name="newPerson" required></select>
                    </div>
                  </div>
                
                  <div id="targetCalendarWrapper" class="form-field" style="display:none;">
                    <label>請點選對象欲交換的班別：</label>
                    <div id="targetCalendarContainer" class="interactive-calendar" style="min-height:200px;">
                      (請先選擇對象人員)
                    </div>
                  </div>
                
                  <button type="button" id="preSubmitBtn" class="submit-btn">送出申請</button>
                </form>

              </div>
            </div>
            <div id="successorView" class="view">
              <div class="controls">
                <label for="successorDate">選擇日期:</label>
                <select id="successorDate"></select>
                <label for="successorRole">選擇班別:</label>
                <select id="successorRole">
                  <option>主任(日)</option>
                  <option>主任(夜)</option>
                  <option>副主任(日)</option>
                  <option>副主任(夜)</option>
                  <option>督導(日)</option>
                  <option>督導(夜)</option>
                </select>
                <button id="successorQueryBtn" class="submit-btn" style="padding: 8px 20px; font-size: 1.1em;">查詢</button>
              </div>
              <div id="successor-results">
                <h3>可用人選列表:</h3>
                <div id="successor-list">(請先選擇日期與班別後查詢)</div>
              </div>
            </div>
          </div>

        <div id="account" class="page">
          <div id="changePasswordView" class="view active">
            <div class="form-container">
              <h3>更換密碼</h3>
              <div id="passwordMessageContainer"></div>
              <form id="changePasswordForm" class="form-grid">
                <div class="form-field">
                  <label for="currentPassword">目前密碼</label>
                  <input type="password" id="currentPassword" required>
                </div>
                <div class="form-field">
                  <label for="newPassword">新密碼 (至少8碼/須包含英文大小寫&數字)</label>
                  <input type="password" id="newPassword" required minlength="8">
                </div>
                <div class="form-field">
                  <label for="confirmNewPassword">確認新密碼</label>
                  <input type="password" id="confirmNewPassword" required minlength="8">
                </div>
                <button type="submit" id="changePasswordBtn" class="submit-btn">確認更換</button>
              </form>
            </div>
          </div>
        </div>
      </main>
    </div> </div> 
    
    <div id="logout-confirm">
    <p>確認登出?</p>
    <button id="confirm-logout-yes">是，確定</button>
    <button id="confirm-logout-no">否</button>
  </div>

  <div id="confirmModal" class="modal-overlay">
  <div class="modal-box">
    <h3>申請確認</h3>
    <div id="modalContent" class="modal-content">
      </div>
    <div class="modal-actions">
      <button id="modalCancel" class="modal-btn btn-cancel">取消</button>
      <button id="modalConfirm" class="modal-btn btn-confirm">確認送出</button>
    </div>
  </div>
</div>

  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBLSvbvQ5Zjj1mGm1c595qtqoBLxfnRs6c",
      authDomain: "occ-shift.firebaseapp.com",
      projectId: "occ-shift",
      storageBucket: "occ-shift.firebasestorage.app",
      messagingSenderId: "67882760777",
      appId: "1:67882760777:web:72f0fbeb590f097bd89d98"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    // 5秒後，為啟動畫面加上 hidden class 讓它淡出
setTimeout(() => {
  const splash = document.getElementById('splash-screen');
  if (splash) {
    splash.classList.add('hidden');
  }
}, 2300);

    const loginContainer = document.getElementById('login-container');
    const appWrapper = document.getElementById('app-wrapper');
    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');

    auth.onAuthStateChanged(user => {
            if (user) {
loginContainer.style.display = 'none';
appWrapper.style.display = 'flex';
if (typeof initializeApp !== 'undefined' && !window.appInitialized) {
setTimeout(() => {
initializeApp(user);
window.appInitialized = true;
}, 100);
}
}
else {
        loginContainer.style.display = 'flex';
        appWrapper.style.display = 'none';
      }
    });

    loginForm.addEventListener('submit', e => {
      e.preventDefault();
      const email = loginForm['email'].value;
      const password = loginForm['password'].value;
      auth.signInWithEmailAndPassword(email, password)
        .catch(error => {
          loginError.textContent = '登入失敗：' + error.message;
        });
    });

    function initializeApp(user) {
      // 1. 在 state 中新增 hasScrolledToToday 旗標
      const state = { 
        currentView: 'personalCalendarView', 
        currentPage: 'home', 
        currentDate: new Date(), 
        cachedData: {}, 
        selectedPerson: '', 
        highlightPerson1: '', 
        highlightPerson2: '', 
        loggedInUserName: '',
        hasScrolledToToday: false // 新增：紀錄是否已自動滑動
      };

      const DOMElements = {
        header: document.querySelector('.header'),
        sidebar: document.getElementById('sidebar'), sidebarToggle: document.getElementById('sidebar-toggle'), overlay: document.getElementById('overlay'),
        contentWrapper: document.getElementById('content-wrapper'), sidebarNav: document.getElementById('sidebar-nav'),
        logoutBtn: document.getElementById('logout-btn'), logoutConfirm: document.getElementById('logout-confirm'),
        confirmLogoutYes: document.getElementById('confirm-logout-yes'), confirmLogoutNo: document.getElementById('confirm-logout-no'),
        pages: document.querySelectorAll('.page'), userInfo: document.getElementById('user-info'),
        monthTitle: document.getElementById('monthTitle'), prevMonthBtn: document.getElementById('prevMonthBtn'), nextMonthBtn: document.getElementById('nextMonthBtn'),
        homeViewSelector: document.getElementById('homeViewSelector'), shiftZoneViewSelector: document.getElementById('shiftZoneViewSelector'),
        viewSelectors: document.querySelectorAll('.view-selector'),
        messageContainer: document.getElementById('messageContainer'), dailyCardView: document.getElementById('dailyCardView'), fullTableView: document.getElementById('fullTableView'),
        tableContainer: document.getElementById('tableContainer'), personalCalendarView: document.getElementById('personalCalendarView'), personSelector: document.getElementById('personSelector'),
        shiftChangeView: document.getElementById('shiftChangeView'), shiftChangeForm: document.getElementById('shiftChangeForm'), formMessageContainer: document.getElementById('formMessageContainer'),
        
        changeType: document.getElementById('changeType'), 
        submitBtn: document.getElementById('submitBtn'), 
        preSubmitBtn: document.getElementById('preSubmitBtn'),
        highlighter1: document.getElementById('highlighter1'),
        highlighter2: document.getElementById('highlighter2'),

        successorView: document.getElementById('successorView'),
        successorDate: document.getElementById('successorDate'),
        successorRole: document.getElementById('successorRole'),
        successorQueryBtn: document.getElementById('successorQueryBtn'),
        successorList: document.getElementById('successor-list'),
        changePasswordView: document.getElementById('changePasswordView'),
        changePasswordForm: document.getElementById('changePasswordForm'),
        changePasswordBtn: document.getElementById('changePasswordBtn'),
        passwordMessageContainer: document.getElementById('passwordMessageContainer'),
        myScheduleTitle: document.getElementById('myScheduleTitle'),
        myPersonalCalendarContainer: document.getElementById('myPersonalCalendarContainer'),
        colleagueCalendarContainer: document.getElementById('colleagueCalendarContainer'),

        sourceCalendarContainer: document.getElementById('sourceCalendarContainer'),
        targetCalendarContainer: document.getElementById('targetCalendarContainer'),
        targetCalendarWrapper: document.getElementById('targetCalendarWrapper'),
        originalDateInput: document.getElementById('originalDate'),
        originalShiftInput: document.getElementById('originalShift'),
        swappedDateInput: document.getElementById('swappedDate'),
        swappedShiftInput: document.getElementById('swappedShift'),
        confirmModal: document.getElementById('confirmModal'),
        modalContent: document.getElementById('modalContent'),
        modalCancel: document.getElementById('modalCancel'),
        modalConfirm: document.getElementById('modalConfirm'),
      };

      state.loggedInUserName = user.displayName || user.email.split('@')[0];

      const googleSheetWebAppUrl = 'https://script.google.com/macros/s/AKfycbyUqr1JydB4Yr3xAY0UFzOktl6wFnsDvoMIkeCZVFy64y0UzGX_q34IHN50ZqwcZ7PWYw/exec';
      const SPREADSHEET_IDS = {
        '2025-9': '1f8TdH6swpmGvxNddyx-4jES_BwnSO-sk5ZpGcdlECSA',
        '2025-10': '1NwYOWUbqgQ3u2QNEb2mHUoGbAu35mXKM_C9hNBK2AZg',
        '2025-11': '1-DqIAPXBNGsvgbRtscD-yTmhy-8Hjplf43BIg8qhb1Q',
        '2025-12': '1KhUeLq4ru7Szc0iBWWmBlP0dpTEO700O_j1Z3AZHztk',
        '2026-1': '1evaYVTyuU3BhzjnI7U6kenvqBzBWb2rI9O11GtMIPB8',
        '2026-2': '1_OmJdSlq8PC-oDX3unvUi2aXzsSpSok0aGQAzBhhXFE',
      };  
       
      const customNameSortOrder = ['明榮', '玉林', '玉茹', '章育', '琦祥', '義東', '文華', '政偉', '政昆', '偉揚', '彥平', '建昌', '保吉', '聲明', '志祥', '仲喬', '懋荃', '子翔', '家鋐', '佳玲', '健凱', '映蓉', '敬舜', '天豪','祈雯', '佑丞', '宥柔', '品妍', '伊筠', '貞瑜', '映笛', '家琪', '昕珆', '詳崴', '宗勳', '凱程', '怡君', '芃安', '璽元', '翌安', '暐喬', '莉詩', '宜霖', '定國', '人鋒', '處長', '副座', '科長'];
      const shiftList = ['日_主任', '夜_主任', '日_T2副主任', '夜_T2副主任', '日_T2作業', '日_T2航廈', '日_T2通聯', '日_T2營運', '夜_T2作業', '夜_T2航廈', '夜_T2通聯', '日_T1副主任', '夜_T1副主任', '日_T1作業', '日_T1航廈', '日_T1營運', '夜_T1作業', '夜_T1航廈', '夜_T1營運'];
      const positions = [
        { label: '主任\n(日)', type: 'DAY', group: 'DIR' }, { label: '主任\n(夜)', type: 'NIGHT', group: 'DIR' }, { label: 'T2\n副主任\n(日)', type: 'DAY', group: 'T2' }, { label: 'T2\n副主任\n(夜)', type: 'NIGHT', group: 'T2' }, { label: 'T2\n作業\n(日)', type: 'DAY', group: 'T2' }, { label: 'T2\n航廈\n(日)', type: 'DAY', group: 'T2' }, { label: 'T2\n通聯\n(日)', type: 'DAY', group: 'T2' }, { label: 'T2\n營運\n(日)', type: 'DAY', group: 'T2' }, { label: 'T2\n作業\n(夜)', type: 'NIGHT', group: 'T2' }, { label: 'T2\n航廈\n(夜)', type: 'NIGHT', group: 'T2' }, { label: 'T2\n通聯\n(夜)', type: 'NIGHT', group: 'T2' }, { label: 'T1\n副主任\n(日)', type: 'DAY', group: 'T1' }, { label: 'T1\n副主任\n(夜)', type: 'NIGHT', group: 'T1' }, { label: 'T1\n作業\n(日)', type: 'DAY', group: 'T1' }, { label: 'T1\n航廈\n(日)', type: 'DAY', group: 'T1' }, { label: 'T1\n營運\n(日)', type: 'DAY', group: 'T1' }, { label: 'T1\n作業\n(夜)', type: 'NIGHT', group: 'T1' }, { label: 'T1\n航廈\n(夜)', type: 'NIGHT', group: 'T1' }, { label: 'T1\n營運\n(夜)', type: 'NIGHT', group: 'T1' }
      ];


      // --- 函數定義 ---
      
      // 2. 新增「嘗試滑動到今天」的輔助函式
      function attemptScrollToToday() {
        if (state.hasScrolledToToday) return; // 如果已經滑過，就跳出
        
        // 稍微延遲以確保畫面已經渲染/顯示
        setTimeout(() => {
            const dailyView = document.getElementById('dailyCardView');
            // 必須確認該頁面是開啟狀態 (有 active class)
            if (!dailyView.classList.contains('active')) return;
            
            const todayCard = document.getElementById('card-today');
            if (todayCard) {
                todayCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                state.hasScrolledToToday = true; // 標記為已完成，之後不再執行
            }
        }, 300);
      }

      DOMElements.userInfo.textContent = `${state.loggedInUserName}你好! :-)`;
      DOMElements.myScheduleTitle.textContent = `${state.loggedInUserName} 的班表`;

      function showMessage(type, text, container = DOMElements.messageContainer) {
        container.innerHTML = `<div class="message-box ${type}">${text}</div>`;
      }

      function clearAllViews() {
        DOMElements.dailyCardView.innerHTML = '';
        DOMElements.tableContainer.innerHTML = '';
        if (DOMElements.myPersonalCalendarContainer) DOMElements.myPersonalCalendarContainer.innerHTML = '';
        if (DOMElements.colleagueCalendarContainer) DOMElements.colleagueCalendarContainer.innerHTML = '';
        DOMElements.messageContainer.innerHTML = '';
        DOMElements.formMessageContainer.innerHTML = '';
      }

      async function fetchData() {
        const year = state.currentDate.getFullYear();
        const month = state.currentDate.getMonth() + 1;
        const fileKey = `${year}-${month}`;
        const spreadsheetId = SPREADSHEET_IDS[fileKey];
        const sheetName = `${month}月_<<預填班表>>`;

        DOMElements.monthTitle.textContent = `${year}年 ${month}月`;
        clearAllViews();

        if (googleSheetWebAppUrl.includes('在這裡貼上')) {
          showMessage('error', '錯誤：您尚未在 index.html 中設定您的 Google Apps Script 網址。');
          return;
        }
        if (!spreadsheetId) {
          showMessage('error', `錯誤：找不到 ${year}年 ${month}月 的班表檔案設定。請在 SPREADSHEET_IDS 中新增對應的檔案 ID。`);
          return;
        }

        if (state.cachedData[fileKey]) {
          renderAllViews(state.cachedData[fileKey]);
          return;
        }

        try {
          showMessage('loading', `正在載入 ${month} 月班表...`);
          const requestUrl = `${googleSheetWebAppUrl}?spreadsheetId=${spreadsheetId}&sheetName=${encodeURIComponent(sheetName)}`;
          const response = await fetch(requestUrl);
          const data = await response.json();

          if (data.error) { throw new Error(data.message); }
          if (!data.schedule || !data.names) {
            throw new Error('從 Google Apps Script 收到的資料格式不正確。請確認您已儲存並「重新部署」了最新版的 Apps Script。');
          }

          state.cachedData[fileKey] = data;
          DOMElements.messageContainer.innerHTML = '';
          renderAllViews(data);
        } catch (error) {
          console.error(`抓取 ${sheetName} 資料失敗:`, error);
          showMessage('error', `無法載入 ${month} 月班表！<br><b>錯誤詳情：</b><br>${error.message}`);
        }
      }

      function renderAllViews(data) {
        renderDailyCards(data.schedule);
        const sortedNames = getSortedNames(data.names);
        populatePersonSelector(sortedNames, DOMElements.personSelector, "請選擇人員...");
        populatePersonSelector(sortedNames, DOMElements.highlighter1, "無");
        populatePersonSelector(sortedNames, DOMElements.highlighter2, "無");
        populateShiftChangeForm(sortedNames, shiftList);
        renderFullTable(data.schedule);
        renderPersonalCalendar(data.schedule, state.loggedInUserName, DOMElements.myPersonalCalendarContainer);
        renderPersonalCalendar(data.schedule, state.selectedPerson, DOMElements.colleagueCalendarContainer);
      }

      function getSortedNames(apiNames) {
        return [...apiNames].sort((a, b) => {
          const indexA = customNameSortOrder.indexOf(a);
          const indexB = customNameSortOrder.indexOf(b);
          if (indexA !== -1 && indexB !== -1) return indexA - indexB;
          if (indexA !== -1) return -1;
          if (indexB !== -1) return 1;
          return a.localeCompare(b, 'zh-Hant');
        });
      }

      function populateShiftChangeForm(names, shifts) {
        const personSelectors = DOMElements.shiftChangeForm.querySelectorAll('select[name="originalPerson"], select[name="newPerson"]');
        personSelectors.forEach(selector => {
          const currentVal = selector.value;
          selector.innerHTML = '';
          const defaultOpt = document.createElement('option');
          defaultOpt.value = "";
          defaultOpt.text = "請選擇人員...";
          selector.appendChild(defaultOpt);

          names.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            selector.appendChild(option);
          });
          if (names.includes(currentVal)) selector.value = currentVal;
        });

        const dateSelectors = DOMElements.shiftChangeForm.querySelectorAll('select[name="originalDate"]');
        const month = state.currentDate.getMonth() + 1;
        const year = state.currentDate.getFullYear();
        const daysInMonth = new Date(year, month, 0).getDate();
        
        if (DOMElements.successorDate) {
          DOMElements.successorDate.innerHTML = '';
          for (let i = 1; i <= daysInMonth; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `${month}/${i}`;
            DOMElements.successorDate.appendChild(option);
          }
        }
      }

      async function handleFormSubmit(e) {
        if(e.preventDefault) e.preventDefault();
        
        const btn = DOMElements.preSubmitBtn; 
        btn.disabled = true;
        btn.textContent = '處理中...';
        showMessage('loading', '正在送出申請...', DOMElements.formMessageContainer);

        const formData = new FormData(DOMElements.shiftChangeForm); 
        const data = Object.fromEntries(formData.entries());
        const year = state.currentDate.getFullYear();
        const month = state.currentDate.getMonth() + 1;
        const fileKey = `${year}-${month}`;
        const spreadsheetId = SPREADSHEET_IDS[fileKey];
        const payload = { ...data, spreadsheetId, month, submitterName: state.loggedInUserName };

        try {
          const response = await fetch(googleSheetWebAppUrl, {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          });
          const result = await response.json();
          if (result.success) {
            showMessage('success', result.message, DOMElements.formMessageContainer);
            DOMElements.shiftChangeForm.reset();
            DOMElements.sourceCalendarContainer.innerHTML = "(請先選擇人員)";
            DOMElements.targetCalendarContainer.innerHTML = "(請先選擇對象人員)";
            DOMElements.targetCalendarWrapper.style.display = 'none';
            DOMElements.originalDateInput.value = "";
            DOMElements.originalShiftInput.value = "";
            DOMElements.swappedDateInput.value = "";
            DOMElements.swappedShiftInput.value = "";

            delete state.cachedData[fileKey];
            switchPage('home');
            switchView('dailyCardView', DOMElements.homeViewSelector);
            await fetchData();
          } else { throw new Error(result.message); }
        } catch (error) {
          showMessage('error', `申請失敗：<br>${error.message}`, DOMElements.formMessageContainer);
        } finally {
          btn.disabled = false;
          btn.textContent = '送出申請';
        }
      }

      async function handleChangePassword(e) {
        e.preventDefault();
        const btn = DOMElements.changePasswordBtn;
        const msgContainer = DOMElements.passwordMessageContainer;

        btn.disabled = true;
        btn.textContent = '處理中...';
        showMessage('loading', '正在處理您的請求...', msgContainer);

        const currentPassword = DOMElements.changePasswordForm['currentPassword'].value;
        const newPassword = DOMElements.changePasswordForm['newPassword'].value;
        const confirmNewPassword = DOMElements.changePasswordForm['confirmNewPassword'].value;

        if (newPassword !== confirmNewPassword) {
          showMessage('error', '錯誤：新密碼與確認密碼不相符。', msgContainer);
          btn.disabled = false;
          btn.textContent = '確認更換';
          return;
        }

        try {
          const user = auth.currentUser;
          if (!user) {
            throw new Error("使用者未登入，無法更換密碼。");
          }

          const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
          await user.reauthenticateWithCredential(credential);

          await user.updatePassword(newPassword);

          showMessage('success', '密碼已成功更新！', msgContainer);
          DOMElements.changePasswordForm.reset();

        } catch (error) {
          let errorMessage = '發生未知錯誤。';
          if (error.code === 'auth/wrong-password') {
            errorMessage = '您輸入的「目前密碼」不正確。';
          } else if (error.code === 'auth/weak-password') {
            errorMessage = '新密碼強度不足，請確認至少有 6 個字元。';
          } else {
            errorMessage = error.message;
          }
          showMessage('error', `更換密碼失敗：<br>${errorMessage}`, msgContainer);
          console.error("Change Password Error:", error);
        } finally {
          btn.disabled = false;
          btn.textContent = '確認更換';
        }
      }

      function renderDailyCards(scheduleData) {
        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth(); 
        const currentDay = today.getDate();

        const viewYear = state.currentDate.getFullYear();
        const viewMonth = state.currentDate.getMonth();

        const fragment = document.createDocumentFragment();
        
        scheduleData.forEach(dayData => {
          const card = document.createElement('div');
          
          let isToday = (viewYear === currentYear && viewMonth === currentMonth && dayData.day === currentDay);
          
          card.className = isToday ? 'day-card today-highlight open' : 'day-card';

          const groups = {
            group1: { title: '主任 (日) & T2 (日)', html: '' },
            group2: { title: '主任 (夜) & T2 (夜)', html: '' },
            group3: { title: 'T1 (日)', html: '' },
            group4: { title: 'T1 (夜)', html: '' }
          };

          dayData.assignments.forEach((name, i) => {
            const pos = positions[i];
            if (!pos) return;
            const shiftClass = pos.type === 'DAY' ? 'day-shift' : 'night-shift';
            
            const assignmentHTML = `
              <div class="assignment ${shiftClass}">
                <div class="position">${pos.label}</div>
                <div class="name">${name || '–'}</div>
              </div>`;

            if ((pos.group === 'DIR' || pos.group === 'T2') && pos.type === 'DAY') {
              groups.group1.html += assignmentHTML;
            } else if ((pos.group === 'DIR' || pos.group === 'T2') && pos.type === 'NIGHT') {
              groups.group2.html += assignmentHTML;
            } else if (pos.group === 'T1' && pos.type === 'DAY') {
              groups.group3.html += assignmentHTML;
            } else if (pos.group === 'T1' && pos.type === 'NIGHT') {
              groups.group4.html += assignmentHTML;
            }
          });

          let detailsHTML = '';
          Object.values(groups).forEach(group => {
            if (group.html) {
              detailsHTML += `<div class="assignment-row"><div class="assignment-row-title">${group.title}</div><div class="assignment-grid">${group.html}</div></div>`;
            }
          });

          if (isToday) card.id = "card-today";

          card.innerHTML = `<div class="day-header"><h2>${state.currentDate.getMonth() + 1}/${String(dayData.day).padStart(2, '0')} <span class="weekday">星期${dayData.weekday}</span></h2></div><div class="day-details">${detailsHTML}</div>`;
          fragment.appendChild(card);
        });

        DOMElements.dailyCardView.innerHTML = '';
        DOMElements.dailyCardView.appendChild(fragment);
        DOMElements.dailyCardView.querySelectorAll('.day-header').forEach(h => h.addEventListener('click', () => h.parentElement.classList.toggle('open')));
        
        // 3. 在資料渲染完成後，嘗試滑動到今天
        attemptScrollToToday();
      }

      function renderFullTable(scheduleData) {
        let tableHTML = `<div class="table-container"><table class="full-roster-table"><thead><tr>`;
        tableHTML += `<th>日期</th>`;
        positions.forEach((pos, i) => {
          const shiftClass = pos.type === 'DAY' ? 'day-shift' : 'night-shift';
          tableHTML += `<th class="${shiftClass}">${pos.label}</th>`;
        });
        tableHTML += `</tr></thead><tbody>`;
        scheduleData.forEach((dayData, rowIndex) => {
          tableHTML += `<tr>`;
          tableHTML += `<td>${state.currentDate.getMonth() + 1}/${dayData.day} (${dayData.weekday})</td>`;
          dayData.assignments.forEach((name, colIndex) => {
            let highlightClass = '';
            if (state.highlightPerson1 && name === state.highlightPerson1) highlightClass = 'highlight-a';
            else if (state.highlightPerson2 && name === state.highlightPerson2) highlightClass = 'highlight-b';
            tableHTML += `<td class="${highlightClass}">${name || ''}</td>`;
          });
          tableHTML += `</tr>`;
        });
        tableHTML += `</tbody></table></div>`;
        DOMElements.tableContainer.innerHTML = tableHTML;
      }

      function populatePersonSelector(names, selector, defaultOptionText) {
        const currentSelection = selector.value;
        selector.innerHTML = `<option value="">${defaultOptionText}</option>`;
        names.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          selector.appendChild(option);
        });
        if (names.includes(currentSelection)) selector.value = currentSelection;
      }

// 【修正版 V2】月曆渲染邏輯
      // 修正點：在互動模式下 (isInteractive == true)，直接不產生 today class
      function renderPersonalCalendar(scheduleData, personName, containerElement, isInteractive = false, onDayClick = null) {
        if (!containerElement) return;

        const today = new Date();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth();
        const currentDay = today.getDate();

        const year = state.currentDate.getFullYear();
        const month = state.currentDate.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        const personalShifts = {};
        if (personName) {
          scheduleData.forEach(dayData => {
            dayData.assignments.forEach((name, i) => {
              if (name === personName) {
                personalShifts[dayData.day] = { 
                  position: positions[i].label, 
                  type: positions[i].type,
                  fullLabel: positions[i].label.replace(/\n/g, ''),
                  backendValue: shiftList[i] 
                };
              }
            });
          });
        }

        let calendarHTML = `<div class="calendar-grid">`;
        const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
        weekdays.forEach(wd => { calendarHTML += `<div class="calendar-weekday">${wd}</div>`; });
        
        for (let i = 0; i < firstDay; i++) { calendarHTML += `<div class="calendar-day empty"></div>`; }

        for (let day = 1; day <= daysInMonth; day++) {
          const shift = personalShifts[day];
          let shiftClass = 'day-off';
          let shiftInfo = '-';
          let hasShift = "false";
          let shiftDataStr = "";

          if (shift) {
            shiftClass = shift.type === 'DAY' ? 'day-shift' : 'night-shift';
            shiftInfo = shift.position;
            hasShift = "true";
            shiftDataStr = `data-shift-name="${shift.fullLabel}" data-shift-value="${shift.backendValue}" data-shift-type="${shift.type}"`;
          }

          let todayClass = '';
          // 【關鍵修改在這裡】
          // 只有在 "非互動模式 (!isInteractive)" 時，才去判斷是否為今天
          // 這樣調班頁面 (isInteractive 為 true) 就永遠不會有 todayClass
          if (!isInteractive && year === currentYear && month === currentMonth && day === currentDay) {
            todayClass = ' today';
          }

          calendarHTML += `
            <div class="calendar-day ${shiftClass}${todayClass}" 
                data-day="${day}" 
                data-has-shift="${hasShift}" 
                ${shiftDataStr}>
              <div class="day-number">${day}</div>
              <div class="shift-info">${shiftInfo}</div>
            </div>`;
        }
        calendarHTML += `</div>`;
        containerElement.innerHTML = calendarHTML;

        if (isInteractive && onDayClick) {
          const days = containerElement.querySelectorAll('.calendar-day[data-has-shift="true"]');
          days.forEach(dayEl => {
            dayEl.addEventListener('click', () => {
              containerElement.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected-shift'));
              dayEl.classList.add('selected-shift');
              const day = dayEl.getAttribute('data-day');
              const shiftValue = dayEl.getAttribute('data-shift-value'); 
              onDayClick(day, shiftValue); 
            });
          });
        }
      }


      function switchPage(pageName) {
    state.currentPage = pageName;
    DOMElements.pages.forEach(p => p.classList.remove('active'));
    document.getElementById(pageName).classList.add('active');
    DOMElements.sidebarNav.querySelectorAll('a').forEach(a => a.classList.remove('active'));
    DOMElements.sidebarNav.querySelector(`[data-page="${pageName}"]`).classList.add('active');
    DOMElements.viewSelectors.forEach(nav => nav.style.display = 'none');
    if (pageName === 'home') {
        DOMElements.homeViewSelector.style.display = 'flex';
        switchView('personalCalendarView', DOMElements.homeViewSelector);
    } else if (pageName === 'shiftZone') {
        DOMElements.shiftZoneViewSelector.style.display = 'flex';
        switchView('shiftChangeView', DOMElements.shiftZoneViewSelector);
    }
    closeSidebar();
}

      function switchView(viewName, viewSelector) {
    if (!viewSelector) return;
    const currentPageDiv = document.querySelector('.page.active');
    if (!currentPageDiv) return;
    currentPageDiv.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    const targetView = document.getElementById(viewName);
    if (targetView) {
        targetView.classList.add('active');
    }
    viewSelector.querySelectorAll('button').forEach(b => b.classList.remove('active'));
    viewSelector.querySelector(`[data-view="${viewName}"]`).classList.add('active');

    // 4. 切換到每日值班頁面時，也嘗試執行滑動
    if (viewName === 'dailyCardView') {
        attemptScrollToToday();
    }
}

      function openSidebar() {
        DOMElements.sidebar.classList.add('open');
        DOMElements.overlay.style.display = 'block';
      }
      function closeSidebar() {
        DOMElements.sidebar.classList.remove('open');
        DOMElements.overlay.style.display = 'none';
      }

      async function handleSuccessorQuery() {
        const resultsContainer = DOMElements.successorList;
        resultsContainer.textContent = '查詢中...';

        const year = state.currentDate.getFullYear();
        const month = state.currentDate.getMonth() + 1;
        const fileKey = `${year}-${month}`;
        const spreadsheetId = SPREADSHEET_IDS[fileKey];
        const date = DOMElements.successorDate.value;
        const role = DOMElements.successorRole.value;

        if (!spreadsheetId) {
          resultsContainer.textContent = '錯誤：找不到該月份的檔案設定。';
          return;
        }

        try {
          const requestUrl = `${googleSheetWebAppUrl}?action=getSuccessors&spreadsheetId=${spreadsheetId}&year=${year}&month=${month}&date=${date}&role=${encodeURIComponent(role)}`;
          const response = await fetch(requestUrl);
          const data = await response.json();

          if (data.error) { throw new Error(data.message); }

          if (data.successors && data.successors.length > 0) {
            resultsContainer.textContent = data.successors.join('、');
          } else {
            resultsContainer.textContent = '(無可用人選)';
          }
        } catch (error) {
          resultsContainer.textContent = '查詢失敗：' + error.message;
        }
      }

      // --- 事件監聽器 ---
      
DOMElements.sidebarNav.addEventListener('click', e => {
  e.preventDefault();
  if (e.target.tagName === 'A') {
    switchPage(e.target.dataset.page);
  }
});
      DOMElements.header.addEventListener('click', (e) => {
  if (e.target.closest('#sidebar-toggle')) {
    DOMElements.sidebar.classList.contains('open') ? closeSidebar() : openSidebar();
  }
});
      DOMElements.overlay.addEventListener('click', closeSidebar);
      
      DOMElements.logoutBtn.addEventListener('click', () => { DOMElements.logoutConfirm.style.display = 'block'; DOMElements.overlay.style.display = 'block'; });
      DOMElements.confirmLogoutNo.addEventListener('click', () => { DOMElements.logoutConfirm.style.display = 'none'; if (!DOMElements.sidebar.classList.contains('open')) DOMElements.overlay.style.display = 'none'; });
      DOMElements.confirmLogoutYes.addEventListener('click', () => { auth.signOut(); DOMElements.logoutConfirm.style.display = 'none'; DOMElements.overlay.style.display = 'none'; });

      DOMElements.homeViewSelector.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') switchView(e.target.dataset.view, DOMElements.homeViewSelector); });
      DOMElements.shiftZoneViewSelector.addEventListener('click', e => { if (e.target.tagName === 'BUTTON') switchView(e.target.dataset.view, DOMElements.shiftZoneViewSelector); });

      DOMElements.prevMonthBtn.addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() - 1); fetchData(); });
      DOMElements.nextMonthBtn.addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() + 1); fetchData(); });

      DOMElements.personSelector.addEventListener('change', e => {
        state.selectedPerson = e.target.value;
        const fileKey = `${state.currentDate.getFullYear()}-${state.currentDate.getMonth() + 1}`;
        if (state.cachedData[fileKey]) {
          renderPersonalCalendar(state.cachedData[fileKey].schedule, state.selectedPerson, DOMElements.colleagueCalendarContainer);
        }
      });
      DOMElements.highlighter1.addEventListener('change', e => {
        state.highlightPerson1 = e.target.value;
        const fileKey = `${state.currentDate.getFullYear()}-${state.currentDate.getMonth() + 1}`;
        if (state.cachedData[fileKey]) renderFullTable(state.cachedData[fileKey].schedule);
      });
      DOMElements.highlighter2.addEventListener('change', e => {
        state.highlightPerson2 = e.target.value;
        const fileKey = `${state.currentDate.getFullYear()}-${state.currentDate.getMonth() + 1}`;
        if (state.cachedData[fileKey]) renderFullTable(state.cachedData[fileKey].schedule);
      });
      
      DOMElements.shiftChangeForm.querySelector('#originalPerson').addEventListener('change', e => {
          const person = e.target.value;
          const year = state.currentDate.getFullYear();
          const month = state.currentDate.getMonth() + 1;
          const fileKey = `${year}-${month}`;
          
          DOMElements.originalDateInput.value = "";
          DOMElements.originalShiftInput.value = "";

          if(state.cachedData[fileKey]) {
              renderPersonalCalendar(
                  state.cachedData[fileKey].schedule, 
                  person, 
                  DOMElements.sourceCalendarContainer, 
                  true, 
                  (day, shiftName) => {
                      DOMElements.originalDateInput.value = day;
                      DOMElements.originalShiftInput.value = shiftName;
                  }
              );
          }
      });

      DOMElements.changeType.addEventListener('change', e => {
          const isSwap = e.target.value === '調';
          DOMElements.targetCalendarWrapper.style.display = isSwap ? 'block' : 'none';
          
          if (!isSwap) {
              DOMElements.swappedDateInput.value = "";
              DOMElements.swappedShiftInput.value = "";
              DOMElements.targetCalendarContainer.querySelectorAll('.selected-shift').forEach(el => el.classList.remove('selected-shift'));
          }
      });

      DOMElements.shiftChangeForm.querySelector('#newPerson').addEventListener('change', e => {
          const person = e.target.value;
          const year = state.currentDate.getFullYear();
          const month = state.currentDate.getMonth() + 1;
          const fileKey = `${year}-${month}`;

          DOMElements.swappedDateInput.value = "";
          DOMElements.swappedShiftInput.value = "";

          if(state.cachedData[fileKey]) {
              renderPersonalCalendar(
                  state.cachedData[fileKey].schedule, 
                  person, 
                  DOMElements.targetCalendarContainer, 
                  true, 
                  (day, shiftName) => {
                      DOMElements.swappedDateInput.value = day;
                      DOMElements.swappedShiftInput.value = shiftName;
                  }
              );
          }
      });

      DOMElements.preSubmitBtn.addEventListener('click', () => {
          const form = DOMElements.shiftChangeForm;
          const type = form.changeType.value;
          const p1 = form.originalPerson.value;
          const d1 = DOMElements.originalDateInput.value;
          const s1 = DOMElements.originalShiftInput.value;
          const p2 = form.newPerson.value;
          
          if (!p1 || !d1 || !s1) {
              alert("請選擇申請人，並點選行事曆上的班別！");
              return;
          }
          if (!p2) {
              alert("請選擇對象人員！");
              return;
          }
          
          let confirmMsg = "";
          const month = state.currentDate.getMonth() + 1;

          if (type === '調') {
              const d2 = DOMElements.swappedDateInput.value;
              const s2 = DOMElements.swappedShiftInput.value;
              if (!d2 || !s2) {
                  alert("調班模式下，請點選對象行事曆上欲交換的班別！");
                  return;
              }
              confirmMsg = `
                <div style="text-align:left; display:inline-block;">
                  <span style="color:#7D8C91;">${p1}</span> ${month}/${d1} ${s1}<br>
                  <div style="text-align:center; color:#CC9B86; margin: 5px 0;">⇅ 互調</div>
                  <span style="color:#7D8C91;">${p2}</span> ${month}/${d2} ${s2}
                </div>`;
          } else {
              confirmMsg = `
                <div style="text-align:left; display:inline-block;">
                  <span style="color:#7D8C91;">${p1}</span> ${month}/${d1} ${s1}<br>
                  <div style="text-align:center; color:#CC9B86; margin: 5px 0;">➔ 給班</div>
                  <span style="color:#7D8C91;">${p2}</span>
                </div>`;
          }

          DOMElements.modalContent.innerHTML = confirmMsg;
          DOMElements.confirmModal.style.display = 'flex';
      });

      DOMElements.modalCancel.addEventListener('click', () => {
          DOMElements.confirmModal.style.display = 'none';
      });

      DOMElements.modalConfirm.addEventListener('click', () => {
          DOMElements.confirmModal.style.display = 'none';
          handleFormSubmit({ target: DOMElements.shiftChangeForm, preventDefault: () => {} });
      });

      DOMElements.changePasswordForm.addEventListener('submit', handleChangePassword);

      if (DOMElements.successorQueryBtn) {
        DOMElements.successorQueryBtn.addEventListener('click', handleSuccessorQuery);
      }

      switchPage('home');
      fetchData();
    }
  </script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').then(registration => {
        console.log('ServiceWorker registration successful with scope: ', registration.scope);
      }).catch(err => {
        console.log('ServiceWorker registration failed: ', err);
      });
    });
  }
</script>
</body>

</html>

